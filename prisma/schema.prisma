generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------
// MODELOS DE USUARIO Y SEGURIDAD
// ---------------------------------------------------------

enum Role {
  CUSTOMER  // Cliente final
  ADMIN     // Dueño del negocio (Acceso total)
  WAREHOUSE // Bodeguero (Logística, Envios, Inventario)
  SUPPORT   // Agente de Soporte (Chats WhatsApp, Conocimiento RAG)
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hash (Bcrypt)
  name      String?
  role      Role     @default(CUSTOMER)
  
  // WhatsApp Integration
  bsuid     String?  @unique // Business-Scoped User ID
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders    Order[]
  addresses Address[]
  
  // Relation to Session (Optional, can be linked later)
  whatsappSession WhatsAppSession?

  @@map("users")
}

// ---------------------------------------------------------
// MODELOS DE PRODUCTO E INVENTARIO
// ---------------------------------------------------------

model Product {
  id          String   @id @default(uuid())
  sku         String   @unique // Identificador único (Ej: ACE-LAV-10ML)
  name        String
  slug        String   @unique // URL amigable (Ej: aceite-lavanda)
  description String?  @db.Text
  variantName String?  // Nombre de la variante (Ej: "Gotero 10ml")
  benefits    String?  @db.Text // Lista separada por comas
  price       Int      // Precio en centavos o unidad mínima (COP)
  
  // Stock Control
  stock       Int      @default(0) 
  stockReserved Int    @default(0) // Stock comprometido en proceso de pago
  isActive    Boolean  @default(true)

  // Multimedia
  images      String[] // Array de URLs de imágenes

  // Logística (Dimensiones obligatorias para cotizar envío)
  weight      Float    @default(0.2) // Kg
  width       Float    @default(10)  // Cm
  height      Float    @default(10)  // Cm
  length      Float    @default(10)  // Cm
  
  category    String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems  OrderItem[]

  @@map("products")
}

// ---------------------------------------------------------
// MODELOS DE ORDENES Y LOGÍSTICA
// ---------------------------------------------------------

enum OrderStatus {
  PENDING             // Creada, esperando pago o confirmación
  CONFIRMED           // Pago recibido (Wompi) o Confirmada manual (COD)
  PROCESSING          // En preparación (Bodega)
  READY_TO_SHIP       // Guía generada
  PICKUP_REQUESTED    // Recogida solicitada a transportadora
  SHIPPED             // Entregada a transportadora
  DELIVERED           // Entregada al cliente
  CANCELLED           // Anulada
  RETURNED            // Devolución
}

enum PaymentMethod {
  COD               // Contra Entrega
  WOMPI             // Pasarela de Pagos
  TRANSFER          // Transferencia Bancaria Directa
}

model Order {
  id              String        @id @default(uuid()) // ID Interno (UUID)
  readableId      Int           @default(autoincrement()) // ID Corto para cliente (Ej: #1024)
  
  // Relaciones Externas
  externalId      String?       @unique // ID en Venndelo o Wompi Reference
  
  status          OrderStatus   @default(PENDING)
  paymentMethod   PaymentMethod @default(COD)
  
  // Totales (Guardados como snapshot al momento de compra)
  subtotal        Int
  shippingCost    Int
  total           Int
  
  // Cliente (Puede ser Guest o User Registrado)
  userId          String?
  user            User?         @relation(fields: [userId], references: [id])
  customerName    String
  customerEmail   String
  customerPhone   String
  customerId      String?       // Cédula/DNI (Importante para logística)
  notes           String?       // Notas de entrega (Timbre, portería, etc)

  // Direcciones (Snapshots JSON para inmutabilidad historica)
  shippingAddress Json          // { address, city, dept, notes... }
  billingAddress  Json?

  // Logística
  carrier         String?       // "Coordinadora", "Envia", "Venndelo"
  trackingNumber  String?       // Número de Guía
  trackingUrl     String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  items           OrderItem[]

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  
  productId String
  product   Product @relation(fields: [productId], references: [id])
  
  // Snapshots (Por si cambia el producto después)
  sku       String
  name      String
  price     Int     // Precio unitario al momento de compra
  quantity  Int
  
  @@map("order_items")
}

// ---------------------------------------------------------
// MODELOS AUXILIARES
// ---------------------------------------------------------

model Address {
  id        String @id @default(uuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id])
  
  address   String
  city      String
  depto     String
  phone     String
  isDefault Boolean @default(false)
  
  @@map("addresses")
}

// ---------------------------------------------------------
// MODELOS DE AI & KNOWLEDGE BASE (RAG)
// ---------------------------------------------------------

model KnowledgeBase {
  id        String   @id @default(uuid())
  content   String   @db.Text
  metadata  Json?    // { source: "product", id: "...", title: "..." }
  
  // Postgres pgvector support via Prisma Unsupported type
  // Requires: CREATE EXTENSION IF NOT EXISTS vector;
  embedding Unsupported("vector(1536)")?
  
  createdAt DateTime @default(now())
  
  @@map("knowledge_base")
}

// ---------------------------------------------------------
// MODELOS DE WHATSAPP ORCHESTRATOR (PHASE 1)
// ---------------------------------------------------------

model WhatsAppSession {
  id              String   @id @default(uuid())
  phoneNumber     String   @unique
  isBotActive     Boolean  @default(true)
  sessionContext  Json?    // Contexto temporal de la conversacion
  handoverTrigger String?  // Razón del escalamiento humano (si aplica)
  expiresAt       DateTime // Ventana de 24h/72h de Meta
  
  // Link opcional a un usuario registrado
  userId          String?  @unique
  user            User?    @relation(fields: [userId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("whatsapp_sessions")
}
